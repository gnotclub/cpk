#!/bin/sh

OUTPUT_DIR="$PWD/deps"
TMP_FILE_TMPL="/tmp/cpk.XXXX"
TMP_DONE_TMPL="/tmp/cpk-done.XXXX"
TMP_DONE=""
TMP_FILE=""

usage() {
	echo "cpk: usage"
	exit 0;
}

install_pkg() {
	local directory="$1"
	echo "Entering $directory"
	if [ ! -f "$directory/.depends" ]; then
		echo "No .depends file."
		return
	fi
	if grep -Fq "$line" "$TMP_DONE"; then
		echo "$line" "already installed"
		return
	fi
	local line=""
	while IFS= read -r line; do
		if grep -Fq "$line" "$TMP_FILE"; then
			echo "Circular dependency detected: \"$line\""
			continue
		fi
		echo "$line" >> "$TMP_FILE"
		local install_to="$(basename "$line")"
		if echo "$line" | grep -q "git://"; then
			echo "Fetching package $install_to from git"
			git submodule add "$line" "$OUTPUT_DIR/$install_to"
			git submodule init
			git submodule update
		elif stat "$line" > /dev/null 2>&1; then
			echo "Fetching package $install_to from local file system"
			mkdir -p "$OUTPUT_DIR/$install_to"
			rm -rf "$OUTPUT_DIR/$install_to"
			cp -a "$line" "$OUTPUT_DIR/$install_to"
		else
			echo "Fetching package $install_to with curl"
			curl -q --location -O "$line"
			unzip -q -u "$install_to" -d "$OUTPUT_DIR"
			rm "$install_to"
		fi
		install_pkg "$OUTPUT_DIR/$install_to"
		# escape all slashes
		local escaped_line="$(echo "$line" | sed 's/\//\\\//g')"
		sed -i '/'"$escaped_line"'/d' "$TMP_FILE"
		echo "$line" >> "$TMP_DONE"
	done < "$directory/.depends"
}

do_install() {
	TMP_FILE="$(mktemp "$TMP_FILE_TMPL")"
	TMP_DONE="$(mktemp "$TMP_DONE_TMPL")"
	mkdir -p "$OUTPUT_DIR"
	install_pkg "$1"
	rm "$TMP_FILE"
	rm "$TMP_DONE"
}

while getopts "o:" flag; do
	case $flag in
		o ) OUTPUT_DIR=$OPTARG
			;;
		? ) usage $0 ;;
	esac
done
shift $(( OPTIND - 1 ))

do_install "$PWD"
